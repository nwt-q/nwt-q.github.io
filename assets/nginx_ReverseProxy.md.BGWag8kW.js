import{_ as n,C as e,c as p,o as l,j as a,G as t,a8 as h,a as r}from"./chunks/framework.DMZhn_gK.js";const d="/assets/image-20251201092838751.COuogHXN.png",k="/assets/image-20251201103150020.DYQTFK0r.png",x=JSON.parse('{"title":"关于Niginx中反向代理存在的问题","description":"","frontmatter":{},"headers":[],"relativePath":"nginx/ReverseProxy.md","filePath":"nginx/ReverseProxy.md","lastUpdated":1764644138000}'),o={name:"nginx/ReverseProxy.md"};function c(g,s,b,u,E,y){const i=e("ArticleMetadata");return l(),p("div",null,[s[0]||(s[0]=a("h1",{id:"关于niginx中反向代理存在的问题",tabindex:"-1"},[r("关于Niginx中反向代理存在的问题 "),a("a",{class:"header-anchor",href:"#关于niginx中反向代理存在的问题","aria-label":'Permalink to "关于Niginx中反向代理存在的问题"'},"​")],-1)),t(i),s[1]||(s[1]=h(`<p>在使用Nginx反向代理时经常出现这样的问题 <code>使用的过程中出现代理失败 400 Bad Request</code> ， <code>502错误</code> , <code>路径出错</code> , <code>真实IP丢失</code> 等等。 本文总结了开发和部署过程中最常见的 Nginx 反向代理问题， 并给出对用的解决方案，帮助你快速定位和修复问题。</p><details class="details custom-block"><summary>查看当前页目录</summary><nav class="table-of-contents"><ul><li><a href="#关于niginx中反向代理存在的问题">关于Niginx中反向代理存在的问题</a><ul><li><a href="#一、502-bad-gateway">一、502 Bad Gateway</a></li><li><a href="#二、路径拼接异常">二、路径拼接异常</a></li><li><a href="#三、获取不到真实客户端-ip">三、获取不到真实客户端 IP</a></li><li><a href="#四、跨域请求失败">四、跨域请求失败</a></li><li><a href="#五、websocket-无法正常工作">五、WebSocket 无法正常工作</a></li><li><a href="#六、请求体过大导致-413-错误">六、请求体过大导致 413 错误</a></li><li><a href="#七、反向代理跳转失效">七、反向代理跳转失效</a></li><li><a href="#八、https-代理配置问题">八、HTTPS 代理配置问题</a></li><li><a href="#九、文件下载异常或中断">九、文件下载异常或中断</a></li><li><a href="#十、缓存未生效或生效异常">十、缓存未生效或生效异常</a></li><li><a href="#总结">总结</a></li></ul></li></ul></nav></details><h2 id="一、502-bad-gateway" tabindex="-1">一、502 Bad Gateway <a class="header-anchor" href="#一、502-bad-gateway" aria-label="Permalink to &quot;一、502 Bad Gateway&quot;">​</a></h2><p>这个错误意味着 Nginx 无法成功与后端服务器通信。</p><div class="warning custom-block"><p class="custom-block-title">常见原因包括：</p><ul><li><p>后端服务未启动</p></li><li><p>后端监听端口不正确</p></li><li><p>请求被防火墙或 SELinux 拦截</p></li><li><p>后端处理超时未返回响应</p></li></ul></div><div class="tip custom-block"><p class="custom-block-title">解决方案是：</p><p>确认后端服务已经运行</p><p>使用 curl 或 telnet 测试后端端口是否通畅</p></div><p>在 Nginx 中加大连接超时时间，比如：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_connect_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_read_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">120s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这俩指令意思分别为 连接超时时间和读取超时时间</p><h2 id="二、路径拼接异常" tabindex="-1">二、路径拼接异常 <a class="header-anchor" href="#二、路径拼接异常" aria-label="Permalink to &quot;二、路径拼接异常&quot;">​</a></h2><p>使用 proxy_pass 时路径拼接规则容易出错，尤其是当 location 带 <code>/</code> 而 proxy_pass 也带路径时，可能造成重复路径。</p><p>错误示例：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /api/ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://localhost:5000/api/;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果用户请求的是 <code>/api/user</code>，最终转发给后端的会变成 <code>/api/api/user</code>，路径错乱。</p><p>正确写法应为：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /api/ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://localhost:5000/;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>记住：location 有斜杠时，proxy_pass 尾部是否加 <code>/</code> 会影响路径拼接。</p><h2 id="三、获取不到真实客户端-ip" tabindex="-1">三、获取不到真实客户端 IP <a class="header-anchor" href="#三、获取不到真实客户端-ip" aria-label="Permalink to &quot;三、获取不到真实客户端 IP&quot;">​</a></h2><p>Nginx 默认会以自身身份向后端发起请求，因此后端看到的 IP 是 Nginx 的地址，而不是客户端的真实 IP。</p><p>可以通过添加以下配置将真实 IP 传递给后端：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Host $host;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Real-IP $remote_addr;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="四、跨域请求失败" tabindex="-1">四、跨域请求失败 <a class="header-anchor" href="#四、跨域请求失败" aria-label="Permalink to &quot;四、跨域请求失败&quot;">​</a></h2><p>当前端通过 JavaScript 发起跨域请求时，Nginx 如果没有设置相关响应头，浏览器会阻止响应内容。</p><p>可通过以下配置允许跨域</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Access-Control-Allow-Origin *;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Access-Control-Allow-Methods GET, POST, OPTIONS;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Access-Control-Allow-Headers Content-Type, Authorization;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>预检请求还需要处理 OPTIONS：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /api/ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ($request_method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">= </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;OPTIONS&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Content-Length </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        add_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Content-Type text/plain;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 204</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://backend:5000;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="五、websocket-无法正常工作" tabindex="-1">五、WebSocket 无法正常工作 <a class="header-anchor" href="#五、websocket-无法正常工作" aria-label="Permalink to &quot;五、WebSocket 无法正常工作&quot;">​</a></h2><p>WebSocket 是基于 HTTP 协议升级的一种连接方式，需要特殊的头部支持 配置如下：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_http_version </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Upgrade $http_upgrade;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Connection </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;upgrade&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="六、请求体过大导致-413-错误" tabindex="-1">六、请求体过大导致 413 错误 <a class="header-anchor" href="#六、请求体过大导致-413-错误" aria-label="Permalink to &quot;六、请求体过大导致 413 错误&quot;">​</a></h2><p>如果上传文件较大或请求体超出限制，Nginx 会报 <code>413 Request Entity Too Large</code>。</p><p>默认限制只有 1MB，解决办法是设置更大的上传限制：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">client_max_body_size </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">50M</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="七、反向代理跳转失效" tabindex="-1">七、反向代理跳转失效 <a class="header-anchor" href="#七、反向代理跳转失效" aria-label="Permalink to &quot;七、反向代理跳转失效&quot;">​</a></h2><p>某些后端框架返回的跳转链接是绝对路径，导致客户端跳转时直接绕过了 Nginx。</p><p>解决方案：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_redirect </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">off</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_set_header </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Host $host;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>场景重现</strong></p><p>使用nginx代理其他域名或者其它ip的服务其中nginx代理代理失败出现404的情况</p><img src="`+d+'" style="box-shadow:0 4px 8px rgba(0,0,0,0.2);" alt="404"><div class="tip custom-block"><p class="custom-block-title">解决方案</p><p>使用dns代理解决， 在dns服务商处添加对应的域名解析， 子域名解析服务如下图中所示</p></div><img src="'+k+`" style="box-shadow:0 4px 8px rgba(0,0,0,0.2);" alt="dns代理解决"><h2 id="八、https-代理配置问题" tabindex="-1">八、HTTPS 代理配置问题 <a class="header-anchor" href="#八、https-代理配置问题" aria-label="Permalink to &quot;八、HTTPS 代理配置问题&quot;">​</a></h2><p>配置 HTTPS 时，若证书路径错误或权限不对，可能导致 Nginx 无法启动或 TLS 握手失败。</p><p>排查重点：</p><p>证书路径是否正确 证书文件是否可被 Nginx 读取 是否使用 <code>nginx -t</code> 验证语法是否正确</p><h2 id="九、文件下载异常或中断" tabindex="-1">九、文件下载异常或中断 <a class="header-anchor" href="#九、文件下载异常或中断" aria-label="Permalink to &quot;九、文件下载异常或中断&quot;">​</a></h2><p>当文件较大时，下载过程中中断或卡住，通常是由于超时时间或缓冲区配置不合理造成的。</p><p>建议关闭缓冲，并加大超时时间：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_buffering </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">off</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_read_timeout </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">600s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>增加缓冲区：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_buffers </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">16</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 64k</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_busy_buffers_size </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">128k</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="十、缓存未生效或生效异常" tabindex="-1">十、缓存未生效或生效异常 <a class="header-anchor" href="#十、缓存未生效或生效异常" aria-label="Permalink to &quot;十、缓存未生效或生效异常&quot;">​</a></h2><p>可能是因为：</p><p>请求中带有 Authorization 或 Cookie 缓存路径没命中 响应状态码未配置缓存策略</p><p>示例配置：</p><div class="language-nginx vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">proxy_cache_path </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/data/nginx/cache levels=1:2 keys_zone=my_cache:10m inactive=60m max_size=1g;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> /api/ </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_cache </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">my_cache;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_cache_valid </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10m</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>Nginx 的反向代理虽然配置灵活，但细节众多，任何一个字段出错都可能引发故障。理解这些常见问题的根本原因，并掌握排查技巧，是写好稳定代理配置的关键一步。</p>`,60))])}const v=n(o,[["render",c]]);export{x as __pageData,v as default};
